version: '3.8'

services:
  # PostgreSQL with PostGIS
  postgres:
    image: postgis/postgis:15-3.3
    container_name: wildfire-postgres
    environment:
      POSTGRES_DB: wildfire_ops
      POSTGRES_USER: wildfire
      POSTGRES_PASSWORD: wildfire123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wildfire -d wildfire_ops"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    container_name: wildfire-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MQTT Broker (EMQX)
  emqx:
    image: emqx/emqx:5.3.0
    container_name: wildfire-emqx
    environment:
      EMQX_NAME: wildfire-emqx
      EMQX_HOST: localhost
      EMQX_DASHBOARD__DEFAULT_USERNAME: admin
      EMQX_DASHBOARD__DEFAULT_PASSWORD: admin123
    ports:
      - "1883:1883"
      - "8083:8083"
      - "8084:8084"
      - "18083:18083"
    volumes:
      - emqx_data:/opt/emqx/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18083/api/v5/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Gateway
  apigw:
    build:
      context: ../../apps/apigw
      dockerfile: Dockerfile
    container_name: wildfire-apigw
    environment:
      DATABASE_URL: postgresql://wildfire:wildfire123@postgres:5432/wildfire_ops
      REDIS_HOST: redis
      REDIS_PORT: 6379
      MQTT_BROKER: emqx
      MQTT_PORT: 1883
    ports:
      - "8000:8000"
      - "50051:50051"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      emqx:
        condition: service_healthy
    volumes:
      - ../../apps/apigw:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Console (Next.js)
  console:
    build:
      context: ../../apps/console
      dockerfile: Dockerfile
    container_name: wildfire-console
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8000
      NEXT_PUBLIC_MQTT_WS_URL: ws://localhost:8083/mqtt
    ports:
      - "3000:3000"
    depends_on:
      - apigw
    volumes:
      - ../../apps/console:/app
      - /app/node_modules
    command: npm run dev

  # Edge Agent (Mock)
  edge-agent:
    build:
      context: ../../apps/edge-agent
      dockerfile: Dockerfile
    container_name: wildfire-edge-agent
    environment:
      MQTT_BROKER: emqx
      MQTT_PORT: 1883
      DEVICE_ID: edge-device-001
    depends_on:
      emqx:
        condition: service_healthy
    volumes:
      - ../../apps/edge-agent:/app

  # Fusion Service
  fusion:
    build:
      context: ../../apps/fusion
      dockerfile: Dockerfile
    container_name: wildfire-fusion
    environment:
      DATABASE_URL: postgresql://wildfire:wildfire123@postgres:5432/wildfire_ops
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ../../apps/fusion:/app

  # Triangulation Service
  triangulate:
    build:
      context: ../../apps/triangulate
      dockerfile: Dockerfile
    container_name: wildfire-triangulate
    environment:
      DATABASE_URL: postgresql://wildfire:wildfire123@postgres:5432/wildfire_ops
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ../../apps/triangulate:/app

  # Prediction Service
  predict:
    build:
      context: ../../apps/predict
      dockerfile: Dockerfile
    container_name: wildfire-predict
    environment:
      DATABASE_URL: postgresql://wildfire:wildfire123@postgres:5432/wildfire_ops
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ../../apps/predict:/app

  # Summit Integration Service
  summit-integration:
    build:
      context: ../../apps/summit-integration
      dockerfile: Dockerfile
    container_name: wildfire-summit-integration
    environment:
      SUMMIT_API_URL: https://api.summit-os.bigmt.ai
      SUMMIT_API_KEY: ${SUMMIT_API_KEY}
      VIDEO_STREAMING: true
      OFFLINE_MODE: true
    ports:
      - "8001:8001"
    depends_on:
      - apigw
    volumes:
      - ../../apps/summit-integration:/app

  # Sentry Tower Agent
  sentry-tower:
    build:
      context: ../../apps/sentry-tower
      dockerfile: Dockerfile
    container_name: wildfire-sentry-tower
    environment:
      TOWER_ID: tower-001
      TOWER_NAME: Sentry Tower Alpha
      TOWER_LATITUDE: 40.0
      TOWER_LONGITUDE: -120.0
      TOWER_ALTITUDE: 1000.0
      THERMAL_CAMERA_MODEL: FLIR_A35
      THERMAL_CAMERA_RESOLUTION: 640x512
      THERMAL_CAMERA_FPS: 30
      THERMAL_DETECTION_THRESHOLD: 0.7
      ACOUSTIC_ARRAY_ENABLED: true
      ACOUSTIC_MICROPHONES: 4
      ACOUSTIC_DETECTION_THRESHOLD: 0.6
      SUMMIT_API_URL: https://api.summit-os.bigmt.ai
      SUMMIT_API_KEY: ${SUMMIT_API_KEY}
      SUMMIT_VIDEO_STREAMING: true
      SUMMIT_OFFLINE_MODE: true
    depends_on:
      - summit-integration
    volumes:
      - ../../apps/sentry-tower:/app

  # FireLine Bot Controller
  fireline-bot:
    build:
      context: ../../apps/fireline-bot
      dockerfile: Dockerfile
    container_name: wildfire-fireline-bot
    environment:
      BOT_ID: fireline-bot-001
      BOT_NAME: FireLine Alpha
      BOT_MAX_SPEED: 5.0
      BOT_MAX_SLOPE: 30.0
      BOT_CLEARING_WIDTH: 3.0
      BOT_WATER_CAPACITY: 500
      BOT_FUEL_CAPACITY: 50
      BOT_OPERATING_TIME: 8
      BOT_SAFETY_ENABLED: true
      BOT_EMERGENCY_STOP_ENABLED: true
      SUMMIT_API_URL: https://api.summit-os.bigmt.ai
      SUMMIT_API_KEY: ${SUMMIT_API_KEY}
    depends_on:
      - summit-integration
    volumes:
      - ../../apps/fireline-bot:/app

volumes:
  postgres_data:
  redis_data:
  emqx_data:
