version: "3.9"
services:
  postgres:
    image: postgis/postgis:15-3.3
    environment:
      # REQUIRED: Set these in .env.production
      POSTGRES_DB: ${POSTGRES_DB:?POSTGRES_DB must be set}
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER must be set}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command: [
      "postgres",
      "-c", "shared_preload_libraries=postgis-3",
      "-c", "max_connections=100",
      "-c", "shared_buffers=256MB"
    ]
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:?REDIS_PASSWORD must be set}"]
    volumes:
      - redis_data:/data
  emqx:
    image: emqx/emqx:5.3.0
    environment:
      # REQUIRED: Set these in .env.production
      EMQX_DASHBOARD__DEFAULT_USERNAME: ${EMQX_USERNAME:?EMQX_USERNAME must be set}
      EMQX_DASHBOARD__DEFAULT_PASSWORD: ${EMQX_PASSWORD:?EMQX_PASSWORD must be set}
    volumes:
      - emqx_data:/opt/emqx/data
  apigw:
    build:
      context: ../../apps/apigw
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL must be set}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD must be set}
      MQTT_BROKER: emqx
      MQTT_PORT: 1883
      MQTT_USERNAME: ${MQTT_USERNAME}
      MQTT_PASSWORD: ${MQTT_PASSWORD}
      SECRET_KEY: ${SECRET_KEY:?SECRET_KEY must be set}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:?ALLOWED_ORIGINS must be set}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:?ALLOWED_HOSTS must be set}
    depends_on:
      - postgres
      - redis
      - emqx
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
  console:
    build:
      context: ../../apps/console
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:?NEXT_PUBLIC_API_URL must be set}
      NEXT_PUBLIC_MQTT_WS_URL: ${NEXT_PUBLIC_MQTT_WS_URL:?NEXT_PUBLIC_MQTT_WS_URL must be set}
    depends_on:
      - apigw
  triangulate:
    build:
      context: ../../apps/triangulate
      dockerfile: Dockerfile
  predict:
    build:
      context: ../../apps/predict
      dockerfile: Dockerfile
  mission-dispatcher:
    build:
      context: ../../
      dockerfile: apps/mission-dispatcher/Dockerfile
    environment:
      MQTT_URL: ${MQTT_URL:-mqtt://emqx:1883}
      DISPATCHER_MISSIONS_TOPIC: ${DISPATCHER_MISSIONS_TOPIC:-missions/updates}
      SUMMIT_API_URL: http://apigw:8000
      SUMMIT_API_KEY: ${SUMMIT_API_KEY:-dev}

volumes:
  postgres_data:
  redis_data:
  emqx_data:
